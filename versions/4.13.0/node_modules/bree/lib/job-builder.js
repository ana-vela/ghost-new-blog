"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var _require = require('path'),
    join = _require.join;

var isSANB = require('is-string-and-not-blank');

var isValidPath = require('is-valid-path');

var _require2 = require('boolean'),
    boolean = _require2.boolean;

var later = require('@breejs/later');

var _require3 = require('./job-utils'),
    isSchedule = _require3.isSchedule,
    parseValue = _require3.parseValue;

later.date.localTime(); // eslint-disable-next-line complexity

var buildJob = function buildJob(job, config) {
  if (isSANB(job)) {
    var path = join(config.root, job.endsWith('.js') || job.endsWith('.mjs') ? job : "".concat(job, ".").concat(config.defaultExtension));
    return {
      name: job,
      path: path,
      timeout: config.timeout,
      interval: config.interval
    };
  }

  if (typeof job === 'function') {
    var _path = "(".concat(job.toString(), ")()");

    return {
      name: job.name,
      path: _path,
      worker: {
        eval: true
      },
      timeout: config.timeout,
      interval: config.interval
    };
  } // Process job.path


  if (typeof job.path === 'function') {
    var _path2 = "(".concat(job.path.toString(), ")()");

    job.path = _path2;
    job.worker = _objectSpread({
      eval: true
    }, job.worker);
  } else {
    var _path3 = isSANB(job.path) ? job.path : join(config.root, job.name.endsWith('.js') || job.name.endsWith('.mjs') ? job.name : "".concat(job.name, ".").concat(config.defaultExtension));

    if (isValidPath(_path3)) {
      job.path = _path3;
    } else {
      // Assume that it's a transformed eval string
      job.worker = _objectSpread({
        eval: true
      }, job.worker);
    }
  }

  if (typeof job.timeout !== 'undefined') {
    job.timeout = parseValue(job.timeout);
  }

  if (typeof job.interval !== 'undefined') {
    job.interval = parseValue(job.interval);
  } // Build cron


  if (typeof job.cron !== 'undefined') {
    if (isSchedule(job.cron)) {
      job.interval = job.cron; // Delete job.cron;
    } else {
      job.interval = later.parse.cron(job.cron, boolean(typeof job.hasSeconds === 'undefined' ? config.hasSeconds : job.hasSeconds));
    }
  } // If timeout was undefined, cron was undefined,
  // and date was undefined then set the default
  // (as long as the default timeout is >= 0)


  if (Number.isFinite(config.timeout) && config.timeout >= 0 && typeof job.timeout === 'undefined' && typeof job.cron === 'undefined' && typeof job.date === 'undefined' && typeof job.interval === 'undefined') {
    job.timeout = config.timeout;
  } // If interval was undefined, cron was undefined,
  // and date was undefined then set the default
  // (as long as the default interval is > 0, or it was a schedule, or it was valid)


  if ((Number.isFinite(config.interval) && config.interval > 0 || isSchedule(config.interval)) && typeof job.interval === 'undefined' && typeof job.cron === 'undefined' && typeof job.date === 'undefined') {
    job.interval = config.interval;
  }

  return job;
};

module.exports = buildJob;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9qb2ItYnVpbGRlci5qcyJdLCJuYW1lcyI6WyJyZXF1aXJlIiwiam9pbiIsImlzU0FOQiIsImlzVmFsaWRQYXRoIiwiYm9vbGVhbiIsImxhdGVyIiwiaXNTY2hlZHVsZSIsInBhcnNlVmFsdWUiLCJkYXRlIiwibG9jYWxUaW1lIiwiYnVpbGRKb2IiLCJqb2IiLCJjb25maWciLCJwYXRoIiwicm9vdCIsImVuZHNXaXRoIiwiZGVmYXVsdEV4dGVuc2lvbiIsIm5hbWUiLCJ0aW1lb3V0IiwiaW50ZXJ2YWwiLCJ0b1N0cmluZyIsIndvcmtlciIsImV2YWwiLCJjcm9uIiwicGFyc2UiLCJoYXNTZWNvbmRzIiwiTnVtYmVyIiwiaXNGaW5pdGUiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O2VBQWlCQSxPQUFPLENBQUMsTUFBRCxDO0lBQWhCQyxJLFlBQUFBLEk7O0FBQ1IsSUFBTUMsTUFBTSxHQUFHRixPQUFPLENBQUMseUJBQUQsQ0FBdEI7O0FBQ0EsSUFBTUcsV0FBVyxHQUFHSCxPQUFPLENBQUMsZUFBRCxDQUEzQjs7Z0JBQ29CQSxPQUFPLENBQUMsU0FBRCxDO0lBQW5CSSxPLGFBQUFBLE87O0FBQ1IsSUFBTUMsS0FBSyxHQUFHTCxPQUFPLENBQUMsZUFBRCxDQUFyQjs7Z0JBQ21DQSxPQUFPLENBQUMsYUFBRCxDO0lBQWxDTSxVLGFBQUFBLFU7SUFBWUMsVSxhQUFBQSxVOztBQUVwQkYsS0FBSyxDQUFDRyxJQUFOLENBQVdDLFNBQVgsRyxDQUVBOztBQUNBLElBQU1DLFFBQVEsR0FBRyxTQUFYQSxRQUFXLENBQUNDLEdBQUQsRUFBTUMsTUFBTixFQUFpQjtBQUNoQyxNQUFJVixNQUFNLENBQUNTLEdBQUQsQ0FBVixFQUFpQjtBQUNmLFFBQU1FLElBQUksR0FBR1osSUFBSSxDQUNmVyxNQUFNLENBQUNFLElBRFEsRUFFZkgsR0FBRyxDQUFDSSxRQUFKLENBQWEsS0FBYixLQUF1QkosR0FBRyxDQUFDSSxRQUFKLENB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ID0gcmVxdWlyZSgnaXMtc3RyaW5nLWFuZC1ub3QtYmxhbmsnKTtcbmNvbnN0IGlzVmFsaWRQYXRoID0gcmVxdWlyZSgnaXMtdmFsaWQtcGF0aCcpO1xuY29uc3QgeyBib29sZWFuIH0gPSByZXF1aXJlKCdib29sZWFuJyk7XG5jb25zdCBsYXRlciA9IHJlcXVpcmUoJ0BicmVlanMvbGF0ZXInKTtcbmNvbnN0IHsgaXNTY2hlZHVsZSwgcGFyc2VWYWx1ZSB9ID0gcmVxdWlyZSgnLi9qb2ItdXRpbHMnKTtcblxubGF0ZXIuZGF0ZS5sb2NhbFRpbWUoKTtcblxuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGNvbXBsZXhpdHlcbmNvbnN0IGJ1aWxkSm9iID0gKGpvYiwgY29uZmlnKSA9PiB7XG4gIGlmIChpc1NBTkIoam9iKSkge1xuICAgIGNvbnN0IHBhdGggPSBqb2luKFxuICAgICAgY29uZmlnLnJvb3QsXG4gICAgICBqb2IuZW5kc1dpdGgoJy5qcycpIHx8IGpvYi5lbmRzV2l0aCgnLm1qcycpXG4gICAgICAgID8gam9iXG4gICAgICAgIDogYCR7am9ifS4ke2NvbmZpZy5kZWZhdWx0RXh0ZW5zaW9ufWBcbiAgICApO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIG5hbWU6IGpvYixcbiAgICAgIHBhdGgsXG4gICAgICB0aW1lb3V0OiBjb25maWcudGltZW91dCxcbiAgICAgIGludGVydmFsOiBjb25maWcuaW50ZXJ2YWxcbiAgICB9O1xuICB9XG5cbiAgaWYgKHR5cGVvZiBqb2IgPT09ICdmdW5jdGlvbicpIHtcbiAgICBjb25zdCBwYXRoID0gYCgke2pvYi50b1N0cmluZygpfSkoKWA7XG5cbiAgICByZXR1cm4ge1xuICAgICAgbmFtZTogam9iLm5hbWUsXG4gICAgICBwYXRoLFxuICAgICAgd29ya2VyOiB7IGV2YWw6IHRydWUgfSxcbiAgICAgIHRpbWVvdXQ6IGNvbmZpZy50aW1lb3V0LFxuICAgICAgaW50ZXJ2YWw6IGNvbmZpZy5pbnRlcnZhbFxuICAgIH07XG4gIH1cblxuICAvLyBQcm9jZXNzIGpvYi5wYXRoXG4gIGlmICh0eXBlb2Ygam9iLnBhdGggPT09ICdmdW5jdGlvbicpIHtcbiAgICBjb25zdCBwYXRoID0gYCgke2pvYi5wYXRoLnRvU3RyaW5nKCl9KSgpYDtcblxuICAgIGpvYi5wYXRoID0gcGF0aDtcbiAgICBqb2Iud29ya2VyID0ge1xuICAgICAgZXZhbDogdHJ1ZSxcbiAgICAgIC4uLmpvYi53b3JrZXJcbiAgICB9O1xuICB9IGVsc2Uge1xuICAgIGNvbnN0IHBhdGggPSBpc1NBTkIoam9iLnBhdGgpXG4gICAgICA/IGpvYi5wYXRoXG4gICAgICA6IGpvaW4oXG4gICAgICAgICAgY29uZmlnLnJvb3QsXG4gICAgICAgICAgam9iLm5hbWUuZW5kc1dpdGgoJy5qcycpIHx8IGpvYi5uYW1lLmVuZHNXaXRoKCcubWpzJylcbiAgICAgICAgICAgID8gam9iLm5hbWVcbiAgICAgICAgICAgIDogYCR7am9iLm5hbWV9LiR7Y29uZmlnLmRlZmF1bHRFeHRlbnNpb259YFxuICAgICAgICApO1xuXG4gICAgaWYgKGlzVmFsaWRQYXRoKHBhdGgpKSB7XG4gICAgICBqb2IucGF0aCA9IHBhdGg7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIEFzc3VtZSB0aGF0IGl0J3MgYSB0cmFuc2Zvcm1lZCBldmFsIHN0cmluZ1xuICAgICAgam9iLndvcmtlciA9IHtcbiAgICAgICAgZXZhbDogdHJ1ZSxcbiAgICAgICAgLi4uam9iLndvcmtlclxuICAgICAgfTtcbiAgICB9XG4gIH1cblxuICBpZiAodHlwZW9mIGpvYi50aW1lb3V0ICE9PSAndW5kZWZpbmVkJykge1xuICAgIGpvYi50aW1lb3V0ID0gcGFyc2VWYWx1ZShqb2IudGltZW91dCk7XG4gIH1cblxuICBpZiAodHlwZW9mIGpvYi5pbnRlcnZhbCAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICBqb2IuaW50ZXJ2YWwgPSBwYXJzZVZhbHVlKGpvYi5pbnRlcnZhbCk7XG4gIH1cblxuICAvLyBCdWlsZCBjcm9uXG4gIGlmICh0eXBlb2Ygam9iLmNyb24gIT09ICd1bmRlZmluZWQnKSB7XG4gICAgaWYgKGlzU2NoZWR1bGUoam9iLmNyb24pKSB7XG4gICAgICBqb2IuaW50ZXJ2YWwgPSBqb2IuY3JvbjtcbiAgICAgIC8vIERlbGV0ZSBqb2IuY3JvbjtcbiAgICB9IGVsc2Uge1xuICAgICAgam9iLmludGVydmFsID0gbGF0ZXIucGFyc2UuY3JvbihcbiAgICAgICAgam9iLmNyb24sXG4gICAgICAgIGJvb2xlYW4oXG4gICAgICAgICAgdHlwZW9mIGpvYi5oYXNTZWNvbmRzID09PSAndW5kZWZpbmVkJ1xuICAgICAgICAgICAgPyBjb25maWcuaGFzU2Vjb25kc1xuICAgICAgICAgICAgOiBqb2IuaGFzU2Vjb25kc1xuICAgICAgICApXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8vIElmIHRpbWVvdXQgd2FzIHVuZGVmaW5lZCwgY3JvbiB3YXMgdW5kZWZpbmVkLFxuICAvLyBhbmQgZGF0ZSB3YXMgdW5kZWZpbmVkIHRoZW4gc2V0IHRoZSBkZWZhdWx0XG4gIC8vIChhcyBsb25nIGFzIHRoZSBkZWZhdWx0IHRpbWVvdXQgaXMgPj0gMClcbiAgaWYgKFxuICAgIE51bWJlci5pc0Zpbml0ZShjb25maWcudGltZW91dCkgJiZcbiAgICBjb25maWcudGltZW91dCA+PSAwICYmXG4gICAgdHlwZW9mIGpvYi50aW1lb3V0ID09PSAndW5kZWZpbmVkJyAmJlxuICAgIHR5cGVvZiBqb2IuY3JvbiA9PT0gJ3VuZGVmaW5lZCcgJiZcbiAgICB0eXBlb2Ygam9iLmRhdGUgPT09ICd1bmRlZmluZWQnICYmXG4gICAgdHlwZW9mIGpvYi5pbnRlcnZhbCA9PT0gJ3VuZGVmaW5lZCdcbiAgKSB7XG4gICAgam9iLnRpbWVvdXQgPSBjb25maWcudGltZW91dDtcbiAgfVxuXG4gIC8vIElmIGludGVydmFsIHdhcyB1bmRlZmluZWQsIGNyb24gd2FzIHVuZGVmaW5lZCxcbiAgLy8gYW5kIGRhdGUgd2FzIHVuZGVmaW5lZCB0aGVuIHNldCB0aGUgZGVmYXVsdFxuICAvLyAoYXMgbG9uZyBhcyB0aGUgZGVmYXVsdCBpbnRlcnZhbCBpcyA+IDAsIG9yIGl0IHdhcyBhIHNjaGVkdWxlLCBvciBpdCB3YXMgdmFsaWQpXG4gIGlmIChcbiAgICAoKE51bWJlci5pc0Zpbml0ZShjb25maWcuaW50ZXJ2YWwpICYmIGNvbmZpZy5pbnRlcnZhbCA+IDApIHx8XG4gICAgICBpc1NjaGVkdWxlKGNvbmZpZy5pbnRlcnZhbCkpICYmXG4gICAgdHlwZW9mIGpvYi5pbnRlcnZhbCA9PT0gJ3VuZGVmaW5lZCcgJiZcbiAgICB0eXBlb2Ygam9iLmNyb24gPT09ICd1bmRlZmluZWQnICYmXG4gICAgdHlwZW9mIGpvYi5kYXRlID09PSAndW5kZWZpbmVkJ1xuICApIHtcbiAgICBqb2IuaW50ZXJ2YWwgPSBjb25maWcuaW50ZXJ2YWw7XG4gIH1cblxuICByZXR1cm4gam9iO1xufTtcblxubW9kdWxlLmV4cG9ydHMgPSBidWlsZEpvYjtcbiJdfQ==