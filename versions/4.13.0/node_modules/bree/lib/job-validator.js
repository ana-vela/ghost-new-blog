"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _typeof2 = _interopRequireDefault(require("@babel/runtime/helpers/typeof"));

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

function _createForOfIteratorHelper(o, allowArrayLike) { var it; if (typeof Symbol === "undefined" || o[Symbol.iterator] == null) { if (Array.isArray(o) || (it = _unsupportedIterableToArray(o)) || allowArrayLike && o && typeof o.length === "number") { if (it) o = it; var i = 0; var F = function F() {}; return { s: F, n: function n() { if (i >= o.length) return { done: true }; return { done: false, value: o[i++] }; }, e: function e(_e) { throw _e; }, f: F }; } throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); } var normalCompletion = true, didErr = false, err; return { s: function s() { it = o[Symbol.iterator](); }, n: function n() { var step = it.next(); normalCompletion = step.done; return step; }, e: function e(_e2) { didErr = true; err = _e2; }, f: function f() { try { if (!normalCompletion && it.return != null) it.return(); } finally { if (didErr) throw err; } } }; }

function _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === "string") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === "Object" && o.constructor) n = o.constructor.name; if (n === "Map" || n === "Set") return Array.from(o); if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }

function _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var fs = require('fs');

var _require = require('path'),
    join = _require.join;

var combineErrors = require('combine-errors');

var cron = require('cron-validate');

var isSANB = require('is-string-and-not-blank');

var isValidPath = require('is-valid-path');

var threads = require('bthreads');

var _require2 = require('./job-utils'),
    getName = _require2.getName,
    isSchedule = _require2.isSchedule,
    parseValue = _require2.parseValue;

var validateReservedJobName = function validateReservedJobName(name) {
  // Don't allow a job to have the `index` file name
  if (['index', 'index.js', 'index.mjs'].includes(name)) {
    return new Error('You cannot use the reserved job name of "index", "index.js", nor "index.mjs"');
  }
};

var validateStringJob = function validateStringJob(job, i, config) {
  var errors = [];
  var jobNameError = validateReservedJobName(job);

  if (jobNameError) {
    throw jobNameError;
  }

  if (!config.root) {
    errors.push(new Error("Job #".concat(i + 1, " \"").concat(job, "\" requires root directory option to auto-populate path")));
    throw combineErrors(errors);
  }

  var path = join(config.root, job.endsWith('.js') || job.endsWith('.mjs') ? job : "".concat(job, ".").concat(config.defaultExtension));
  /* istanbul ignore next */

  if (!threads.browser) {
    var stats = fs.statSync(path);

    if (!stats.isFile()) {
      throw new Error("Job #".concat(i + 1, " \"").concat(job, "\" path missing: ").concat(path));
    }
  }
};

var validateFunctionJob = function validateFunctionJob(job, i) {
  var errors = [];
  var path = "(".concat(job.toString(), ")()"); // Can't be a built-in or bound function

  if (path.includes('[native code]')) {
    errors.push(new Error("Job #".concat(i + 1, " can't be a bound or built-in function")));
  }

  if (errors.length > 0) {
    throw combineErrors(errors);
  }
};

var validateJobPath = function validateJobPath(job, prefix, config) {
  var errors = [];

  if (typeof job.path === 'function') {
    var path = "(".concat(job.path.toString(), ")()"); // Can't be a built-in or bound function

    if (path.includes('[native code]')) {
      errors.push(new Error("".concat(prefix, " can't be a bound or built-in function")));
    }
  } else if (!isSANB(job.path) && !config.root) {
    errors.push(new Error("".concat(prefix, " requires root directory option to auto-populate path")));
  } else {
    // Validate path
    var _path = isSANB(job.path) ? job.path : join(config.root, job.name.endsWith('.js') || job.name.endsWith('.mjs') ? job.name : "".concat(job.name, ".").concat(config.defaultExtension));

    if (isValidPath(_path)) {
      try {
        /* istanbul ignore next */
        if (!threads.browser) {
          var stats = fs.statSync(_path); // eslint-disable-next-line max-depth

          if (!stats.isFile()) {
            throw new Error("".concat(prefix, " path missing: ").concat(_path));
          }
        }
      } catch (err) {
        /* istanbul ignore next */
        errors.push(err);
      }
    }
  }

  return errors;
};

var cronValidateWithSeconds = function cronValidateWithSeconds(job, config) {
  var preset = job.cronValidate && job.cronValidate.preset ? job.cronValidate.preset : config.cronValidate && config.cronValidate.preset ? config.cronValidate.preset : 'default';

  var override = _objectSpread(_objectSpread(_objectSpread({}, config.cronValidate && config.cronValidate.override ? config.cronValidate.override : {}), job.cronValidate && job.cronValidate.override ? job.cronValidate.override : {}), {}, {
    useSeconds: true
  });

  return _objectSpread(_objectSpread(_objectSpread({}, config.cronValidate), job.cronValidate), {}, {
    preset: preset,
    override: override
  });
};

var validateCron = function validateCron(job, prefix, config) {
  var errors = [];

  if (!isSchedule(job.cron)) {
    // If `hasSeconds` was `true` then set `cronValidate` and inherit any existing options
    var cronValidate = job.hasSeconds ? cronValidateWithSeconds(job, config) : config.cronValidate; //
    // validate cron pattern
    // (must support patterns such as `* * L * *` and `0 0/5 14 * * ?` (and aliases too)
    //
    //  <https://github.com/Airfooox/cron-validate/issues/67>
    //

    var result = cron(job.cron, cronValidate);

    if (!result.isValid()) {
      // NOTE: it is always valid
      // const schedule = later.schedule(
      //   later.parse.cron(
      //     job.cron,
      //     boolean(
      //       typeof job.hasSeconds === 'undefined'
      //         ? config.hasSeconds
      //         : job.hasSeconds
      //     )
      //   )
      // );
      // if (schedule.isValid()) {
      //   job.interval = schedule;
      // } // else {
      //   errors.push(
      //     new Error(
      //       `${prefix} had an invalid cron schedule (see <https://crontab.guru> if you need help)`
      //     )
      //   );
      // }
      var _iterator = _createForOfIteratorHelper(result.getError()),
          _step;

      try {
        for (_iterator.s(); !(_step = _iterator.n()).done;) {
          var message = _step.value;
          errors.push(new Error("".concat(prefix, " had an invalid cron pattern: ").concat(message)));
        }
      } catch (err) {
        _iterator.e(err);
      } finally {
        _iterator.f();
      }
    }
  }

  return errors;
};

var validateJobName = function validateJobName(job, i, reservedNames) {
  var errors = [];
  var name = getName(job);

  if (!name) {
    errors.push(new Error("Job #".concat(i + 1, " is missing a name")));
  } // Throw an error if duplicate job names


  if (reservedNames.includes(name)) {
    errors.push(new Error("Job #".concat(i + 1, " has a duplicate job name of ").concat(getName(job))));
  }

  return errors;
};

var validate = function validate(job, i, names, config) {
  var errors = validateJobName(job, i, names);

  if (errors.length > 0) {
    throw combineErrors(errors);
  } // Support a simple string which we will transform to have a path


  if (isSANB(job)) {
    return validateStringJob(job, i, config);
  } // Job is a function


  if (typeof job === 'function') {
    return validateFunctionJob(job, i);
  } // Use a prefix for errors


  var prefix = "Job #".concat(i + 1, " named \"").concat(job.name, "\"");
  errors.push.apply(errors, (0, _toConsumableArray2.default)(validateJobPath(job, prefix, config))); // Don't allow users to mix interval AND cron

  if (typeof job.interval !== 'undefined' && typeof job.cron !== 'undefined') {
    errors.push(new Error("".concat(prefix, " cannot have both interval and cron configuration")));
  } // Don't allow users to mix timeout AND date


  if (typeof job.timeout !== 'undefined' && typeof job.date !== 'undefined') {
    errors.push(new Error("".concat(prefix, " cannot have both timeout and date")));
  }

  var jobNameError = validateReservedJobName(job.name);

  if (jobNameError) {
    errors.push(jobNameError);
  } // Validate date


  if (typeof job.date !== 'undefined' && !(job.date instanceof Date)) {
    errors.push(new Error("".concat(prefix, " had an invalid Date of ").concat(job.date)));
  }

  ['timeout', 'interval'].forEach(function (prop) {
    if (typeof job[prop] !== 'undefined') {
      try {
        parseValue(job[prop]);
      } catch (err) {
        errors.push(combineErrors([new Error("".concat(prefix, " had an invalid ").concat(prop, " of ").concat(job.timeout)), err]));
      }
    }
  }); // Validate hasSeconds

  if (typeof job.hasSeconds !== 'undefined' && typeof job.hasSeconds !== 'boolean') {
    errors.push(new Error("".concat(prefix, " had hasSeconds value of ").concat(job.hasSeconds, " (it must be a Boolean)")));
  } // Validate cronValidate


  if (typeof job.cronValidate !== 'undefined' && (0, _typeof2.default)(job.cronValidate) !== 'object') {
    errors.push(new Error("".concat(prefix, " had cronValidate value set, but it must be an Object")));
  }

  if (typeof job.cron !== 'undefined') {
    errors.push.apply(errors, (0, _toConsumableArray2.default)(validateCron(job, prefix, config)));
  } // Validate closeWorkerAfterMs


  if (typeof job.closeWorkerAfterMs !== 'undefined' && (!Number.isFinite(job.closeWorkerAfterMs) || job.closeWorkerAfterMs <= 0)) {
    errors.push(new Error("".concat(prefix, " had an invalid closeWorkersAfterMs value of ").concat(job.closeWorkersAfterMs, " (it must be a finite number > 0)")));
  }

  if (errors.length > 0) {
    throw combineErrors(errors);
  }
};

module.exports = validate;
module.exports.cronValidateWithSeconds = cronValidateWithSeconds;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9qb2ItdmFsaWRhdG9yLmpzIl0sIm5hbWVzIjpbImZzIiwicmVxdWlyZSIsImpvaW4iLCJjb21iaW5lRXJyb3JzIiwiY3JvbiIsImlzU0FOQiIsImlzVmFsaWRQYXRoIiwidGhyZWFkcyIsImdldE5hbWUiLCJpc1NjaGVkdWxlIiwicGFyc2VWYWx1ZSIsInZhbGlkYXRlUmVzZXJ2ZWRKb2JOYW1lIiwibmFtZSIsImluY2x1ZGVzIiwiRXJyb3IiLCJ2YWxpZGF0ZVN0cmluZ0pvYiIsImpvYiIsImkiLCJjb25maWciLCJlcnJvcnMiLCJqb2JOYW1lRXJyb3IiLCJyb290IiwicHVzaCIsInBhdGgiLCJlbmRzV2l0aCIsImRlZmF1bHRFeHRlbnNpb24iLCJicm93c2VyIiwic3RhdHMiLCJzdGF0U3luYyIsImlzRmlsZSIsInZhbGlkYXRlRnVuY3Rpb25Kb2IiLCJ0b1N0cmluZyIsImxlbmd0aCIsInZhbGlkYXRlSm9iUGF0aCIsInByZWZpeCIsImVyciIsImNyb25WYWxpZGF0ZVdpdGhTZWNvbmRzIiwicHJlc2V0IiwiY3JvblZhbGlkYXRlIiwib3ZlcnJpZGUiLCJ1c2VTZWNvbmRzIiwidmFsaWRhdGVDcm9uIiwiaGFzU2Vjb25kcyIsInJlc3VsdCIsImlzVmFsaWQiLCJnZXRFcnJvciIsIm1lc3NhZ2UiLCJ2YWxpZGF0ZUpvYk5hbWUiLCJyZXNlcnZlZE5hbWVzIiwidmFsaWRhdGUiLCJuYW1lcyIsImludGVydmFsIiwidGltZW91dCIsImRhdGUiLCJEYXRlIiwiZm9yRWFjaCIsInByb3AiLCJjbG9zZVdvcmtlckFmdGVyTXMiLCJOdW1iZXIiLCJpc0Zpbml0ZSIsImNsb3NlV29ya2Vyc0FmdGVyTXMiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLElBQU1BLEVBQUUsR0FBR0MsT0FBTyxDQUFDLElBQUQsQ0FBbEI7O2VBQ2lCQSxPQUFPLENBQUMsTUFBRCxDO0lBQWhCQyxJLFlBQUFBLEk7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SUFBUCxDQUNFLElBQUlSLEtBQUosV0FDS29CLE1BREwsMERBQzJEbEIsR0FBRyxDQUFDNEMsbUJBRC9ELHVDQURGO0FBS0Q7O0FBRUQsTUFBSXpDLE1BQU0sQ0FBQ2EsTUFBUCxHQUFnQixDQUFwQixFQUF1QjtBQUNyQixVQUFNN0IsYUFBYSxDQUFDZ0IsTUFBRCxDQUFuQjtBQUNEO0FBQ0YsQ0F0R0Q7O0FBd0dBMEMsTUFBTSxDQUFDQyxPQUFQLEdBQWlCYixRQUFqQjtBQUNBWSxNQUFNLENBQUNDLE9BQVAsQ0FBZTFCLHVCQUFmLEdBQXlDQSx1QkFBekMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBmcyA9IHJlcXVpcmUoJ2ZzJyk7XG5jb25zdCB7IGpvaW4gfSA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IGNvbWJpbmVFcnJvcnMgPSByZXF1aXJlKCdjb21iaW5lLWVycm9ycycpO1xuY29uc3QgY3JvbiA9IHJlcXVpcmUoJ2Nyb24tdmFsaWRhdGUnKTtcbmNvbnN0IGlzU0FOQiA9IHJlcXVpcmUoJ2lzLXN0cmluZy1hbmQtbm90LWJsYW5rJyk7XG5jb25zdCBpc1ZhbGlkUGF0aCA9IHJlcXVpcmUoJ2lzLXZhbGlkLXBhdGgnKTtcbmNvbnN0IHRocmVhZHMgPSByZXF1aXJlKCdidGhyZWFkcycpO1xuXG5jb25zdCB7IGdldE5hbWUsIGlzU2NoZWR1bGUsIHBhcnNlVmFsdWUgfSA9IHJlcXVpcmUoJy4vam9iLXV0aWxzJyk7XG5cbmNvbnN0IHZhbGlkYXRlUmVzZXJ2ZWRKb2JOYW1lID0gKG5hbWUpID0+IHtcbiAgLy8gRG9uJ3QgYWxsb3cgYSBqb2IgdG8gaGF2ZSB0aGUgYGluZGV4YCBmaWxlIG5hbWVcbiAgaWYgKFsnaW5kZXgnLCAnaW5kZXguanMnLCAnaW5kZXgubWpzJ10uaW5jbHVkZXMobmFtZSkpIHtcbiAgICByZXR1cm4gbmV3IEVycm9yKFxuICAgICAgJ1lvdSBjYW5ub3QgdXNlIHRoZSByZXNlcnZlZCBqb2IgbmFtZSBvZiBcImluZGV4XCIsIFwiaW5kZXguanNcIiwgbm9yIFwiaW5kZXgubWpzXCInXG4gICAgKTtcbiAgfVxufTtcblxuY29uc3QgdmFsaWRhdGVTdHJpbmdKb2IgPSAoam9iLCBpLCBjb25maWcpID0+IHtcbiAgY29uc3QgZXJyb3JzID0gW107XG5cbiAgY29uc3Qgam9iTmFtZUVycm9yID0gdmFsaWRhdGVSZXNlcnZlZEpvYk5hbWUoam9iKTtcbiAgaWYgKGpvYk5hbWVFcnJvcikge1xuICAgIHRocm93IGpvYk5hbWVFcnJvcjtcbiAgfVxuXG4gIGlmICghY29uZmlnLnJvb3QpIHtcbiAgICBlcnJvcnMucHVzaChcbiAgICAgIG5ldyBFcnJvcihcbiAgICAgICAgYEpvYiAjJHtcbiAgICAgICAgICBpICsgMVxuICAgICAgICB9IFwiJHtqb2J9XCIgcmVxdWlyZXMgcm9vdCBkaXJlY3Rvcnkgb3B0aW9uIHRvIGF1dG8tcG9wdWxhdGUgcGF0aGBcbiAgICAgIClcbiAgICApO1xuICAgIHRocm93IGNvbWJpbmVFcnJvcnMoZXJyb3JzKTtcbiAgfVxuXG4gIGNvbnN0IHBhdGggPSBqb2luKFxuICAgIGNvbmZpZy5yb290LFxuICAgIGpvYi5lbmRzV2l0aCgnLmpzJykgfHwgam9iLmVuZHNXaXRoKCcubWpzJylcbiAgICAgID8gam9iXG4gICAgICA6IGAke2pvYn0uJHtjb25maWcuZGVmYXVsdEV4dGVuc2lvbn1gXG4gICk7XG5cbiAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi9cbiAgaWYgKCF0aHJlYWRzLmJyb3dzZXIpIHtcbiAgICBjb25zdCBzdGF0cyA9IGZzLnN0YXRTeW5jKHBhdGgpO1xuICAgIGlmICghc3RhdHMuaXNGaWxlKCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgSm9iICMke2kgKyAxfSBcIiR7am9ifVwiIHBhdGggbWlzc2luZzogJHtwYXRofWApO1xuICAgIH1cbiAgfVxufTtcblxuY29uc3QgdmFsaWRhdGVGdW5jdGlvbkpvYiA9IChqb2IsIGkpID0+IHtcbiAgY29uc3QgZXJyb3JzID0gW107XG5cbiAgY29uc3QgcGF0aCA9IGAoJHtqb2IudG9TdHJpbmcoKX0pKClgO1xuICAvLyBDYW4ndCBiZSBhIGJ1aWx0LWluIG9yIGJvdW5kIGZ1bmN0aW9uXG4gIGlmIChwYXRoLmluY2x1ZGVzKCdbbmF0aXZlIGNvZGVdJykpIHtcbiAgICBlcnJvcnMucHVzaChcbiAgICAgIG5ldyBFcnJvcihgSm9iICMke2kgKyAxfSBjYW4ndCBiZSBhIGJvdW5kIG9yIGJ1aWx0LWluIGZ1bmN0aW9uYClcbiAgICApO1xuICB9XG5cbiAgaWYgKGVycm9ycy5sZW5ndGggPiAwKSB7XG4gICAgdGhyb3cgY29tYmluZUVycm9ycyhlcnJvcnMpO1xuICB9XG59O1xuXG5jb25zdCB2YWxpZGF0ZUpvYlBhdGggPSAoam9iLCBwcmVmaXgsIGNvbmZpZykgPT4ge1xuICBjb25zdCBlcnJvcnMgPSBbXTtcblxuICBpZiAodHlwZW9mIGpvYi5wYXRoID09PSAnZnVuY3Rpb24nKSB7XG4gICAgY29uc3QgcGF0aCA9IGAoJHtqb2IucGF0aC50b1N0cmluZygpfSkoKWA7XG5cbiAgICAvLyBDYW4ndCBiZSBhIGJ1aWx0LWluIG9yIGJvdW5kIGZ1bmN0aW9uXG4gICAgaWYgKHBhdGguaW5jbHVkZXMoJ1tuYXRpdmUgY29kZV0nKSkge1xuICAgICAgZXJyb3JzLnB1c2gobmV3IEVycm9yKGAke3ByZWZpeH0gY2FuJ3QgYmUgYSBib3VuZCBvciBidWlsdC1pbiBmdW5jdGlvbmApKTtcbiAgICB9XG4gIH0gZWxzZSBpZiAoIWlzU0FOQihqb2IucGF0aCkgJiYgIWNvbmZpZy5yb290KSB7XG4gICAgZXJyb3JzLnB1c2goXG4gICAgICBuZXcgRXJyb3IoXG4gICAgICAgIGAke3ByZWZpeH0gcmVxdWlyZXMgcm9vdCBkaXJlY3Rvcnkgb3B0aW9uIHRvIGF1dG8tcG9wdWxhdGUgcGF0aGBcbiAgICAgIClcbiAgICApO1xuICB9IGVsc2Uge1xuICAgIC8vIFZhbGlkYXRlIHBhdGhcbiAgICBjb25zdCBwYXRoID0gaXNTQU5CKGpvYi5wYXRoKVxuICAgICAgPyBqb2IucGF0aFxuICAgICAgOiBqb2luKFxuICAgICAgICAgIGNvbmZpZy5yb290LFxuICAgICAgICAgIGpvYi5uYW1lLmVuZHNXaXRoKCcuanMnKSB8fCBqb2IubmFtZS5lbmRzV2l0aCgnLm1qcycpXG4gICAgICAgICAgICA/IGpvYi5uYW1lXG4gICAgICAgICAgICA6IGAke2pvYi5uYW1lfS4ke2NvbmZpZy5kZWZhdWx0RXh0ZW5zaW9ufWBcbiAgICAgICAgKTtcbiAgICBpZiAoaXNWYWxpZFBhdGgocGF0aCkpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBuZXh0ICovXG4gICAgICAgIGlmICghdGhyZWFkcy5icm93c2VyKSB7XG4gICAgICAgICAgY29uc3Qgc3RhdHMgPSBmcy5zdGF0U3luYyhwYXRoKTtcbiAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbWF4LWRlcHRoXG4gICAgICAgICAgaWYgKCFzdGF0cy5pc0ZpbGUoKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAke3ByZWZpeH0gcGF0aCBtaXNzaW5nOiAke3BhdGh9YCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgLyogaXN0YW5idWwgaWdub3JlIG5leHQgKi9cbiAgICAgICAgZXJyb3JzLnB1c2goZXJyKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZXR1cm4gZXJyb3JzO1xufTtcblxuY29uc3QgY3JvblZhbGlkYXRlV2l0aFNlY29uZHMgPSAoam9iLCBjb25maWcpID0+IHtcbiAgY29uc3QgcHJlc2V0ID1cbiAgICBqb2IuY3JvblZhbGlkYXRlICYmIGpvYi5jcm9uVmFsaWRhdGUucHJlc2V0XG4gICAgICA/IGpvYi5jcm9uVmFsaWRhdGUucHJlc2V0XG4gICAgICA6IGNvbmZpZy5jcm9uVmFsaWRhdGUgJiYgY29uZmlnLmNyb25WYWxpZGF0ZS5wcmVzZXRcbiAgICAgID8gY29uZmlnLmNyb25WYWxpZGF0ZS5wcmVzZXRcbiAgICAgIDogJ2RlZmF1bHQnO1xuICBjb25zdCBvdmVycmlkZSA9IHtcbiAgICAuLi4oY29uZmlnLmNyb25WYWxpZGF0ZSAmJiBjb25maWcuY3JvblZhbGlkYXRlLm92ZXJyaWRlXG4gICAgICA/IGNvbmZpZy5jcm9uVmFsaWRhdGUub3ZlcnJpZGVcbiAgICAgIDoge30pLFxuICAgIC4uLihqb2IuY3JvblZhbGlkYXRlICYmIGpvYi5jcm9uVmFsaWRhdGUub3ZlcnJpZGVcbiAgICAgID8gam9iLmNyb25WYWxpZGF0ZS5vdmVycmlkZVxuICAgICAgOiB7fSksXG4gICAgdXNlU2Vjb25kczogdHJ1ZVxuICB9O1xuXG4gIHJldHVybiB7XG4gICAgLi4uY29uZmlnLmNyb25WYWxpZGF0ZSxcbiAgICAuLi5qb2IuY3JvblZhbGlkYXRlLFxuICAgIHByZXNldCxcbiAgICBvdmVycmlkZVxuICB9O1xufTtcblxuY29uc3QgdmFsaWRhdGVDcm9uID0gKGpvYiwgcHJlZml4LCBjb25maWcpID0+IHtcbiAgY29uc3QgZXJyb3JzID0gW107XG5cbiAgaWYgKCFpc1NjaGVkdWxlKGpvYi5jcm9uKSkge1xuICAgIC8vIElmIGBoYXNTZWNvbmRzYCB3YXMgYHRydWVgIHRoZW4gc2V0IGBjcm9uVmFsaWRhdGVgIGFuZCBpbmhlcml0IGFueSBleGlzdGluZyBvcHRpb25zXG4gICAgY29uc3QgY3JvblZhbGlkYXRlID0gam9iLmhhc1NlY29uZHNcbiAgICAgID8gY3JvblZhbGlkYXRlV2l0aFNlY29uZHMoam9iLCBjb25maWcpXG4gICAgICA6IGNvbmZpZy5jcm9uVmFsaWRhdGU7XG5cbiAgICAvL1xuICAgIC8vIHZhbGlkYXRlIGNyb24gcGF0dGVyblxuICAgIC8vIChtdXN0IHN1cHBvcnQgcGF0dGVybnMgc3VjaCBhcyBgKiAqIEwgKiAqYCBhbmQgYDAgMC81IDE0ICogKiA/YCAoYW5kIGFsaWFzZXMgdG9vKVxuICAgIC8vXG4gICAgLy8gIDxodHRwczovL2dpdGh1Yi5jb20vQWlyZm9vb3gvY3Jvbi12YWxpZGF0ZS9pc3N1ZXMvNjc+XG4gICAgLy9cbiAgICBjb25zdCByZXN1bHQgPSBjcm9uKGpvYi5jcm9uLCBjcm9uVmFsaWRhdGUpO1xuXG4gICAgaWYgKCFyZXN1bHQuaXNWYWxpZCgpKSB7XG4gICAgICAvLyBOT1RFOiBpdCBpcyBhbHdheXMgdmFsaWRcbiAgICAgIC8vIGNvbnN0IHNjaGVkdWxlID0gbGF0ZXIuc2NoZWR1bGUoXG4gICAgICAvLyAgIGxhdGVyLnBhcnNlLmNyb24oXG4gICAgICAvLyAgICAgam9iLmNyb24sXG4gICAgICAvLyAgICAgYm9vbGVhbihcbiAgICAgIC8vICAgICAgIHR5cGVvZiBqb2IuaGFzU2Vjb25kcyA9PT0gJ3VuZGVmaW5lZCdcbiAgICAgIC8vICAgICAgICAgPyBjb25maWcuaGFzU2Vjb25kc1xuICAgICAgLy8gICAgICAgICA6IGpvYi5oYXNTZWNvbmRzXG4gICAgICAvLyAgICAgKVxuICAgICAgLy8gICApXG4gICAgICAvLyApO1xuICAgICAgLy8gaWYgKHNjaGVkdWxlLmlzVmFsaWQoKSkge1xuICAgICAgLy8gICBqb2IuaW50ZXJ2YWwgPSBzY2hlZHVsZTtcbiAgICAgIC8vIH0gLy8gZWxzZSB7XG4gICAgICAvLyAgIGVycm9ycy5wdXNoKFxuICAgICAgLy8gICAgIG5ldyBFcnJvcihcbiAgICAgIC8vICAgICAgIGAke3ByZWZpeH0gaGFkIGFuIGludmFsaWQgY3JvbiBzY2hlZHVsZSAoc2VlIDxodHRwczovL2Nyb250YWIuZ3VydT4gaWYgeW91IG5lZWQgaGVscClgXG4gICAgICAvLyAgICAgKVxuICAgICAgLy8gICApO1xuICAgICAgLy8gfVxuXG4gICAgICBmb3IgKGNvbnN0IG1lc3NhZ2Ugb2YgcmVzdWx0LmdldEVycm9yKCkpIHtcbiAgICAgICAgZXJyb3JzLnB1c2goXG4gICAgICAgICAgbmV3IEVycm9yKGAke3ByZWZpeH0gaGFkIGFuIGludmFsaWQgY3JvbiBwYXR0ZXJuOiAke21lc3NhZ2V9YClcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZXR1cm4gZXJyb3JzO1xufTtcblxuY29uc3QgdmFsaWRhdGVKb2JOYW1lID0gKGpvYiwgaSwgcmVzZXJ2ZWROYW1lcykgPT4ge1xuICBjb25zdCBlcnJvcnMgPSBbXTtcbiAgY29uc3QgbmFtZSA9IGdldE5hbWUoam9iKTtcblxuICBpZiAoIW5hbWUpIHtcbiAgICBlcnJvcnMucHVzaChuZXcgRXJyb3IoYEpvYiAjJHtpICsgMX0gaXMgbWlzc2luZyBhIG5hbWVgKSk7XG4gIH1cblxuICAvLyBUaHJvdyBhbiBlcnJvciBpZiBkdXBsaWNhdGUgam9iIG5hbWVzXG4gIGlmIChyZXNlcnZlZE5hbWVzLmluY2x1ZGVzKG5hbWUpKSB7XG4gICAgZXJyb3JzLnB1c2goXG4gICAgICBuZXcgRXJyb3IoYEpvYiAjJHtpICsgMX0gaGFzIGEgZHVwbGljYXRlIGpvYiBuYW1lIG9mICR7Z2V0TmFtZShqb2IpfWApXG4gICAgKTtcbiAgfVxuXG4gIHJldHVybiBlcnJvcnM7XG59O1xuXG5jb25zdCB2YWxpZGF0ZSA9IChqb2IsIGksIG5hbWVzLCBjb25maWcpID0+IHtcbiAgY29uc3QgZXJyb3JzID0gdmFsaWRhdGVKb2JOYW1lKGpvYiwgaSwgbmFtZXMpO1xuXG4gIGlmIChlcnJvcnMubGVuZ3RoID4gMCkge1xuICAgIHRocm93IGNvbWJpbmVFcnJvcnMoZXJyb3JzKTtcbiAgfVxuXG4gIC8vIFN1cHBvcnQgYSBzaW1wbGUgc3RyaW5nIHdoaWNoIHdlIHdpbGwgdHJhbnNmb3JtIHRvIGhhdmUgYSBwYXRoXG4gIGlmIChpc1NBTkIoam9iKSkge1xuICAgIHJldHVybiB2YWxpZGF0ZVN0cmluZ0pvYihqb2IsIGksIGNvbmZpZyk7XG4gIH1cblxuICAvLyBKb2IgaXMgYSBmdW5jdGlvblxuICBpZiAodHlwZW9mIGpvYiA9PT0gJ2Z1bmN0aW9uJykge1xuICAgIHJldHVybiB2YWxpZGF0ZUZ1bmN0aW9uSm9iKGpvYiwgaSk7XG4gIH1cblxuICAvLyBVc2UgYSBwcmVmaXggZm9yIGVycm9yc1xuICBjb25zdCBwcmVmaXggPSBgSm9iICMke2kgKyAxfSBuYW1lZCBcIiR7am9iLm5hbWV9XCJgO1xuXG4gIGVycm9ycy5wdXNoKC4uLnZhbGlkYXRlSm9iUGF0aChqb2IsIHByZWZpeCwgY29uZmlnKSk7XG5cbiAgLy8gRG9uJ3QgYWxsb3cgdXNlcnMgdG8gbWl4IGludGVydmFsIEFORCBjcm9uXG4gIGlmICh0eXBlb2Ygam9iLmludGVydmFsICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2Ygam9iLmNyb24gIT09ICd1bmRlZmluZWQnKSB7XG4gICAgZXJyb3JzLnB1c2goXG4gICAgICBuZXcgRXJyb3IoYCR7cHJlZml4fSBjYW5ub3QgaGF2ZSBib3RoIGludGVydmFsIGFuZCBjcm9uIGNvbmZpZ3VyYXRpb25gKVxuICAgICk7XG4gIH1cblxuICAvLyBEb24ndCBhbGxvdyB1c2VycyB0byBtaXggdGltZW91dCBBTkQgZGF0ZVxuICBpZiAodHlwZW9mIGpvYi50aW1lb3V0ICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2Ygam9iLmRhdGUgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgZXJyb3JzLnB1c2gobmV3IEVycm9yKGAke3ByZWZpeH0gY2Fubm90IGhhdmUgYm90aCB0aW1lb3V0IGFuZCBkYXRlYCkpO1xuICB9XG5cbiAgY29uc3Qgam9iTmFtZUVycm9yID0gdmFsaWRhdGVSZXNlcnZlZEpvYk5hbWUoam9iLm5hbWUpO1xuICBpZiAoam9iTmFtZUVycm9yKSB7XG4gICAgZXJyb3JzLnB1c2goam9iTmFtZUVycm9yKTtcbiAgfVxuXG4gIC8vIFZhbGlkYXRlIGRhdGVcbiAgaWYgKHR5cGVvZiBqb2IuZGF0ZSAhPT0gJ3VuZGVmaW5lZCcgJiYgIShqb2IuZGF0ZSBpbnN0YW5jZW9mIERhdGUpKSB7XG4gICAgZXJyb3JzLnB1c2gobmV3IEVycm9yKGAke3ByZWZpeH0gaGFkIGFuIGludmFsaWQgRGF0ZSBvZiAke2pvYi5kYXRlfWApKTtcbiAgfVxuXG4gIFsndGltZW91dCcsICdpbnRlcnZhbCddLmZvckVhY2goKHByb3ApID0+IHtcbiAgICBpZiAodHlwZW9mIGpvYltwcm9wXSAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIHBhcnNlVmFsdWUoam9iW3Byb3BdKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBlcnJvcnMucHVzaChcbiAgICAgICAgICBjb21iaW5lRXJyb3JzKFtcbiAgICAgICAgICAgIG5ldyBFcnJvcihgJHtwcmVmaXh9IGhhZCBhbiBpbnZhbGlkICR7cHJvcH0gb2YgJHtqb2IudGltZW91dH1gKSxcbiAgICAgICAgICAgIGVyclxuICAgICAgICAgIF0pXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICB9KTtcblxuICAvLyBWYWxpZGF0ZSBoYXNTZWNvbmRzXG4gIGlmIChcbiAgICB0eXBlb2Ygam9iLmhhc1NlY29uZHMgIT09ICd1bmRlZmluZWQnICYmXG4gICAgdHlwZW9mIGpvYi5oYXNTZWNvbmRzICE9PSAnYm9vbGVhbidcbiAgKSB7XG4gICAgZXJyb3JzLnB1c2goXG4gICAgICBuZXcgRXJyb3IoXG4gICAgICAgIGAke3ByZWZpeH0gaGFkIGhhc1NlY29uZHMgdmFsdWUgb2YgJHtqb2IuaGFzU2Vjb25kc30gKGl0IG11c3QgYmUgYSBCb29sZWFuKWBcbiAgICAgIClcbiAgICApO1xuICB9XG5cbiAgLy8gVmFsaWRhdGUgY3JvblZhbGlkYXRlXG4gIGlmIChcbiAgICB0eXBlb2Ygam9iLmNyb25WYWxpZGF0ZSAhPT0gJ3VuZGVmaW5lZCcgJiZcbiAgICB0eXBlb2Ygam9iLmNyb25WYWxpZGF0ZSAhPT0gJ29iamVjdCdcbiAgKSB7XG4gICAgZXJyb3JzLnB1c2goXG4gICAgICBuZXcgRXJyb3IoXG4gICAgICAgIGAke3ByZWZpeH0gaGFkIGNyb25WYWxpZGF0ZSB2YWx1ZSBzZXQsIGJ1dCBpdCBtdXN0IGJlIGFuIE9iamVjdGBcbiAgICAgIClcbiAgICApO1xuICB9XG5cbiAgaWYgKHR5cGVvZiBqb2IuY3JvbiAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICBlcnJvcnMucHVzaCguLi52YWxpZGF0ZUNyb24oam9iLCBwcmVmaXgsIGNvbmZpZykpO1xuICB9XG5cbiAgLy8gVmFsaWRhdGUgY2xvc2VXb3JrZXJBZnRlck1zXG4gIGlmIChcbiAgICB0eXBlb2Ygam9iLmNsb3NlV29ya2VyQWZ0ZXJNcyAhPT0gJ3VuZGVmaW5lZCcgJiZcbiAgICAoIU51bWJlci5pc0Zpbml0ZShqb2IuY2xvc2VXb3JrZXJBZnRlck1zKSB8fCBqb2IuY2xvc2VXb3JrZXJBZnRlck1zIDw9IDApXG4gICkge1xuICAgIGVycm9ycy5wdXNoKFxuICAgICAgbmV3IEVycm9yKFxuICAgICAgICBgJHtwcmVmaXh9IGhhZCBhbiBpbnZhbGlkIGNsb3NlV29ya2Vyc0FmdGVyTXMgdmFsdWUgb2YgJHtqb2IuY2xvc2VXb3JrZXJzQWZ0ZXJNc30gKGl0IG11c3QgYmUgYSBmaW5pdGUgbnVtYmVyID4gMClgXG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIGlmIChlcnJvcnMubGVuZ3RoID4gMCkge1xuICAgIHRocm93IGNvbWJpbmVFcnJvcnMoZXJyb3JzKTtcbiAgfVxufTtcblxubW9kdWxlLmV4cG9ydHMgPSB2YWxpZGF0ZTtcbm1vZHVsZS5leHBvcnRzLmNyb25WYWxpZGF0ZVdpdGhTZWNvbmRzID0gY3JvblZhbGlkYXRlV2l0aFNlY29uZHM7XG4iXX0=